<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes & Tools</title>

    <link
      rel="stylesheet"
      href="./highlightjs/styles/stackoverflow-dark.min.css"
    />
    <script src="./highlightjs/highlight.min.js"></script>

    <style>
      /* ============================================================
   THEME VARIABLES
   Change these values to switch themes instantly
   ============================================================ */
      :root {
        /* Backgrounds */
        --bg-body: #181818;
        --bg-section: #212121;
        --bg-surface: #1a1a1a;
        --bg-surface-2: #2a2a2a;

        /* Borders */
        --border-color: #444;
        --border-surface: #333;
        --border-surface-2: #3a3a3a;

        /* Text */
        --text-main: #e5e5e5;
        --text-muted: #353535;
        --text-heading: #ffffff;
        --text-error: #ff6666;

        /* Interactive states */
        --active-bg: #3f4aff;
        --active-border: #6f78ff;
        --active-text: white;

        /* Highlight.js tweak */
        --code-border: #4c8dff;

        /* Attachment preview */
        --preview-bg: #777;

        /* Spinner */
        --spinner-main: #3498db;
        --spinner-dim: rgba(255, 255, 255, 0.15);

        /* Layout */
        --radius-lg: 12px;
        --radius-md: 8px;
        --radius-sm: 6px;
        --padding-md: 20px;
        --gap-md: 10px;
      }

      /* ============================================================
   BASE STYLES
   ============================================================ */

      body {
        margin: 0;
        padding: 0;
        padding-bottom: 40px;
        background: var(--bg-body);
        color: var(--text-main);
        font-family: "Inter", Arial, sans-serif;
      }

      section {
        margin: 10px 20px;
        padding: var(--padding-md);
        background: var(--bg-section);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
      }

      /* Custom tags should behave like block-level elements */
      heading,
      searching_labels,
      attachments {
        display: block;
      }

      heading {
        font-size: 1.4rem;
        color: var(--text-heading);
      }

      searching_labels {
        color: var(--text-muted);
        font-style: italic;
      }
      searching_labels span {
        margin-right: 10px;
      }

      /* ============================================================
   ATTACHMENTS UI
   ============================================================ */

      .attachment-heading {
        display: inline-block;
        background: var(--bg-surface);
        padding: 10px;
        font-weight: bold;
        border: 1px solid var(--border-surface);
        border-bottom: none;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
      }

      .attachment-list {
        background: var(--bg-surface);
        padding: 10px;
        display: flex;
        gap: var(--gap-md);
        overflow-x: auto;
        white-space: nowrap;
        border: 1px solid var(--border-surface);
        border-radius: 0 var(--radius-md) var(--radius-md) var(--radius-md);
      }

      .attachment-item {
        cursor: pointer;
        padding: 8px 14px;
        background: var(--bg-surface-2);
        border: 1px solid var(--border-surface-2);
        border-radius: var(--radius-sm);
        transition: 0.2s;
        font-size: 0.95rem;
        user-select: none;
      }

      .attachment-item.active {
        background: var(--active-bg);
        border-color: var(--active-border);
        color: var(--active-text);
      }

      /* Preview Box */

      .attachment-preview {
        display: none;
        background: var(--preview-bg);
        border: 1px solid var(--border-surface);
        border-radius: var(--radius-md);
      }

      .preview-frame {
        width: 100%;
        height: 450px;
        border: none;
      }

      /* ============================================================
   LOADING UI
   ============================================================ */

      .spinner {
        width: 32px;
        height: 32px;
        border: 4px solid var(--spinner-dim);
        border-top-color: var(--spinner-main);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        justify-content: center;
      }

      /* ============================================================
   IMAGES + ERRORS
   ============================================================ */

      .img-preview {
        width: 100%;
        border-radius: var(--radius-md);
        display: block;
      }

      .error {
        color: var(--text-error);
        padding: 15px;
      }

      /* ============================================================
   CODE BLOCK OVERRIDE
   ============================================================ */

      pre code {
        border-left: 3px solid var(--code-border);
        border-radius: var(--radius-md);
        padding-left: 12px;
      }

      /* ============================================================
 MEDIA QUERY FOR PRINTING
 ============================================================ */
      @media print {
        /* Remove margins if needed */
        @page {
          size: A4 portrait;
          margin: 10mm;
        }
        /* Avoid color loss or dimming */
        body {
          margin: 0 !important;
          padding: 0 !important;
        }
        /* Ensure images always print */
        img {
          max-width: 100% !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        section {
          min-height: auto !important;
          height: auto !important;
          box-shadow: none !important;
          page-break-inside: avoid !important;
        }
      }
    </style>
  </head>

  <body></body>

  <script>
    /* ---------------------------
            UTILITY FUNCTIONS
    ----------------------------*/

    function toTitleCase(str) {
      return str.toLowerCase().replace(/\b\p{L}/gu, (c) => c.toUpperCase());
    }

    function heading_handler(ele) {
      let srNo = ele.parentElement.id.split("_").at(-1);
      let text = toTitleCase(ele.textContent.trim());
      ele.textContent = `${srNo}. ${text}`;
    }

    function searching_label_handler(ele) {
      let text = ele.textContent
        .split(",,")
        .map((s) => s.trim())
        .filter(Boolean)
        .map((s) => `<span>#${s}</span>`)
        .join("");
      ele.innerHTML = text;
    }

    function attachment_handler(ele) {
      let items = ele.textContent
        .split(",,")
        .map((s) => s.trim())
        .filter(Boolean)
        .map(
          (s) =>
            `<div class="attachment-item" onclick="attachment_click_handler(this)">${s}</div>`
        )
        .join("");

      ele.innerHTML = `
        <div class="attachment-heading">Attachments:</div>
        <div class="attachment-list">${items}</div>
        <div class="attachment-preview"></div>
      `;
    }

    function sanitizeFilename(name) {
      // Convert to string
      name = String(name);

      // Trim whitespace
      name = name.trim();

      // Remove any path-like components (slashes, backslashes)
      name = name.replace(/[/\\]+/g, "");

      // Remove dangerous characters
      name = name.replace(/[`"'<>|?*:{}()[\]]/g, "");

      // Block javascript: or data: URLs
      name = name.replace(/^(javascript|data):/gi, "");

      // Collapse multiple dots (prevents "..", "...", etc.)
      name = name.replace(/\.+/g, ".");

      // Remove leading dots (avoids hidden or dot-dot paths)
      name = name.replace(/^\.+/, "");

      // Prevent empty result
      if (!name) return "unknown";

      return name;
    }

    /* ---------------------------
          ATTACHMENT PREVIEWER
    ----------------------------*/

    async function attachment_click_handler(ele) {
      const file = sanitizeFilename(ele.textContent.trim());
      const preview = ele
        .closest("section")
        .querySelector(".attachment-preview");

      const escapeHTML = (str) =>
        str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");

      if (ele.classList.contains("active")) {
        ele.classList.remove("active");
        preview.style.display = "none";
        preview.innerHTML = "";
        return;
      }

      document
        .querySelectorAll(".attachment-item")
        .forEach((i) => i.classList.remove("active"));
      ele.classList.add("active");

      preview.style.display = "block";
      preview.innerHTML = `
        <div class="loading-row">
          <div class="spinner"></div>
          <span>Loading ${escapeHTML(file)}...</span>
        </div>
      `;

      const url = `./attachments/${file}`;
      const ext = file.includes(".") ? file.split(".").pop().toLowerCase() : "";

      const handlers = {
        pdf: (url) => `<iframe class="preview-frame" src="${url}"></iframe>`,
        mp3: (url) =>
          `<audio controls style="width:100%;"><source src="${url}" type="audio/mpeg"></audio>`,
        wav: (url) =>
          `<audio controls style="width:100%;"><source src="${url}" type="audio/wav"></audio>`,
        ogg: (url) =>
          `<audio controls style="width:100%;"><source src="${url}" type="audio/ogg"></audio>`,
        mp4: (url) =>
          `<video controls style="width:100%;border-radius:8px;"><source src="${url}" type="video/mp4"></video>`,
        webm: (url) =>
          `<video controls style="width:100%;border-radius:8px;"><source src="${url}" type="video/webm"></video>`,
      };

      const imageExts = ["png", "jpg", "jpeg", "gif", "webp"];
      const codeExts = [
        "py",
        "js",
        "ts",
        "css",
        "html",
        "json",
        "c",
        "cpp",
        "java",
        "txt",
      ];

      try {
        if (imageExts.includes(ext)) {
          preview.innerHTML = `
            <img src="${url}" alt="Preview of ${escapeHTML(
            file
          )}" class="img-preview">`;
          return;
        }

        if (handlers[ext]) {
          preview.innerHTML = handlers[ext](url);
          return;
        }

        if (codeExts.includes(ext)) {
          const response = await fetch(url);
          if (!response.ok) {
            preview.innerHTML = `<p class="error">File not found or inaccessible.</p>`;
            return;
          }

          const text = await response.text();
          preview.innerHTML = `
            <pre><code class="language-${ext}">${escapeHTML(text)}</code></pre>
          `;
          const codeBlock = preview.querySelector("code");
          if (codeBlock) hljs.highlightElement(codeBlock);
          return;
        }

        preview.innerHTML = `<iframe class="preview-frame" src="${url}"></iframe>`;
      } catch (e) {
        preview.innerHTML = `<p class="error">Failed to load file.</p>`;
      }
    }

    /* ---------------------------
            NOTES BODY LOADING
    ----------------------------*/
    fetch("./notes_body.html")
      .then((res) => res.text())
      .then((data) => {
        const template = document.createElement("template");
        template.innerHTML = data;
        const root = template.content;

        // run handlers...
        root.querySelectorAll("heading").forEach(heading_handler);
        root
          .querySelectorAll("searching_labels")
          .forEach(searching_label_handler);
        root.querySelectorAll("attachments").forEach(attachment_handler);

        // simply insert the parsed content
        document.body.appendChild(root);

        // highlight
        document.body.querySelectorAll("pre code").forEach((block) => {
          if (!block.classList.contains("hljs")) hljs.highlightElement(block);
        });
      });
  </script>
</html>
